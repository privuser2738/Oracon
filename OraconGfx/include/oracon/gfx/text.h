#ifndef ORACON_GFX_TEXT_H
#define ORACON_GFX_TEXT_H

#include "oracon/gfx/canvas.h"
#include "oracon/gfx/color.h"
#include "oracon/math/vector.h"
#include <string>
#include <map>

namespace oracon {
namespace gfx {

using math::Vec2f;
using core::String;

// Simple 8x8 bitmap font
struct FontGlyph {
    u8 data[8];
};

// Simple bitmap font renderer (8x8 characters)
class BitmapFont {
public:
    BitmapFont() : m_charWidth(8), m_charHeight(8) {
        initializeGlyphs();
    }

    // Draw text at position
    void drawText(Canvas& canvas, const String& text, i32 x, i32 y, const Color& color) const {
        i32 cursorX = x;
        i32 cursorY = y;

        for (char c : text) {
            if (c == '\n') {
                cursorX = x;
                cursorY += m_charHeight;
                continue;
            }

            drawChar(canvas, c, cursorX, cursorY, color);
            cursorX += m_charWidth;
        }
    }

    // Measure text width
    u32 measureText(const String& text) const {
        u32 maxWidth = 0;
        u32 currentWidth = 0;

        for (char c : text) {
            if (c == '\n') {
                maxWidth = std::max(maxWidth, currentWidth);
                currentWidth = 0;
            } else {
                currentWidth += m_charWidth;
            }
        }

        return std::max(maxWidth, currentWidth);
    }

    // Measure text height
    u32 measureHeight(const String& text) const {
        u32 lines = 1;
        for (char c : text) {
            if (c == '\n') lines++;
        }
        return lines * m_charHeight;
    }

    u32 getCharWidth() const { return m_charWidth; }
    u32 getCharHeight() const { return m_charHeight; }

private:
    u32 m_charWidth;
    u32 m_charHeight;
    std::map<char, FontGlyph> m_glyphs;

    void initializeGlyphs() {
        // Basic ASCII characters (space through Z, lowercase, digits, punctuation)
        // Space
        m_glyphs[' '] = {{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};
       
        // Uppercase letters
        m_glyphs['A'] = {{0x18, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00}};
        m_glyphs['B'] = {{0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00}};
        m_glyphs['C'] = {{0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00}};
        m_glyphs['D'] = {{0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00}};
        m_glyphs['E'] = {{0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00}};
        m_glyphs['F'] = {{0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00}};
        m_glyphs['G'] = {{0x3C, 0x42, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['H'] = {{0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00}};
        m_glyphs['I'] = {{0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}};
        m_glyphs['J'] = {{0x1E, 0x08, 0x08, 0x08, 0x08, 0x48, 0x30, 0x00}};
        m_glyphs['K'] = {{0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00}};
        m_glyphs['L'] = {{0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00}};
        m_glyphs['M'] = {{0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00}};
        m_glyphs['N'] = {{0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x00}};
        m_glyphs['O'] = {{0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['P'] = {{0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x00}};
        m_glyphs['Q'] = {{0x3C, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0x00}};
        m_glyphs['R'] = {{0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x00}};
        m_glyphs['S'] = {{0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00}};
        m_glyphs['T'] = {{0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}};
        m_glyphs['U'] = {{0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['V'] = {{0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00}};
        m_glyphs['W'] = {{0x42, 0x42, 0x42, 0x42, 0x5A, 0x66, 0x42, 0x00}};
        m_glyphs['X'] = {{0x42, 0x42, 0x24, 0x18, 0x24, 0x42, 0x42, 0x00}};
        m_glyphs['Y'] = {{0x42, 0x42, 0x24, 0x18, 0x18, 0x18, 0x18, 0x00}};
        m_glyphs['Z'] = {{0x7E, 0x02, 0x04, 0x18, 0x20, 0x40, 0x7E, 0x00}};
        
        // Lowercase
        m_glyphs['a'] = {{0x00, 0x00, 0x3C, 0x02, 0x3E, 0x42, 0x3E, 0x00}};
        m_glyphs['b'] = {{0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x7C, 0x00}};
        m_glyphs['c'] = {{0x00, 0x00, 0x3C, 0x42, 0x40, 0x42, 0x3C, 0x00}};
        m_glyphs['d'] = {{0x02, 0x02, 0x3A, 0x46, 0x42, 0x42, 0x3E, 0x00}};
        m_glyphs['e'] = {{0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x3C, 0x00}};
        m_glyphs['f'] = {{0x0C, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x10, 0x00}};
        m_glyphs['g'] = {{0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x3C}};
        m_glyphs['h'] = {{0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00}};
        m_glyphs['i'] = {{0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x1C, 0x00}};
        m_glyphs['j'] = {{0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x44, 0x38}};
        m_glyphs['k'] = {{0x40, 0x40, 0x44, 0x48, 0x70, 0x48, 0x44, 0x00}};
        m_glyphs['l'] = {{0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C, 0x00}};
        m_glyphs['m'] = {{0x00, 0x00, 0x76, 0x49, 0x49, 0x49, 0x49, 0x00}};
        m_glyphs['n'] = {{0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00}};
        m_glyphs['o'] = {{0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['p'] = {{0x00, 0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40}};
        m_glyphs['q'] = {{0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02}};
        m_glyphs['r'] = {{0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x00}};
        m_glyphs['s'] = {{0x00, 0x00, 0x3E, 0x40, 0x3C, 0x02, 0x7C, 0x00}};
        m_glyphs['t'] = {{0x10, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x0C, 0x00}};
        m_glyphs['u'] = {{0x00, 0x00, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00}};
        m_glyphs['v'] = {{0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00}};
        m_glyphs['w'] = {{0x00, 0x00, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00}};
        m_glyphs['x'] = {{0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00}};
        m_glyphs['y'] = {{0x00, 0x00, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x3C}};
        m_glyphs['z'] = {{0x00, 0x00, 0x7E, 0x04, 0x18, 0x20, 0x7E, 0x00}};
        
        // Numbers
        m_glyphs['0'] = {{0x3C, 0x46, 0x4A, 0x52, 0x62, 0x42, 0x3C, 0x00}};
        m_glyphs['1'] = {{0x18, 0x28, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00}};
        m_glyphs['2'] = {{0x3C, 0x42, 0x02, 0x0C, 0x30, 0x40, 0x7E, 0x00}};
        m_glyphs['3'] = {{0x3C, 0x42, 0x02, 0x1C, 0x02, 0x42, 0x3C, 0x00}};
        m_glyphs['4'] = {{0x04, 0x0C, 0x14, 0x24, 0x7E, 0x04, 0x04, 0x00}};
        m_glyphs['5'] = {{0x7E, 0x40, 0x7C, 0x02, 0x02, 0x42, 0x3C, 0x00}};
        m_glyphs['6'] = {{0x1C, 0x20, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['7'] = {{0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x10, 0x00}};
        m_glyphs['8'] = {{0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00}};
        m_glyphs['9'] = {{0x3C, 0x42, 0x42, 0x3E, 0x02, 0x04, 0x38, 0x00}};
        
        // Punctuation
        m_glyphs['.'] = {{0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}};
        m_glyphs[','] = {{0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x10, 0x20}};
        m_glyphs['!'] = {{0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00}};
        m_glyphs['?'] = {{0x3C, 0x42, 0x02, 0x0C, 0x10, 0x00, 0x10, 0x00}};
        m_glyphs[':'] = {{0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00}};
        m_glyphs['-'] = {{0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00}};
        m_glyphs['\''] = {{0x18, 0x18, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00}};
        m_glyphs['"'] = {{0x24, 0x24, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00}};
        m_glyphs['('] = {{0x04, 0x08, 0x10, 0x10, 0x10, 0x08, 0x04, 0x00}};
        m_glyphs[')'] = {{0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00}};
    }

    void drawChar(Canvas& canvas, char c, i32 x, i32 y, const Color& color) const {
        auto it = m_glyphs.find(c);
        const FontGlyph* glyph = (it != m_glyphs.end()) ? &it->second : &m_glyphs.at(' ');

        for (u32 py = 0; py < 8; py++) {
            u8 row = glyph->data[py];
            for (u32 px = 0; px < 8; px++) {
                if (row & (1 << (7 - px))) {
                    canvas.setPixel(x + px, y + py, color);
                }
            }
        }
    }
};

// Draw text with background (speech bubble style)
inline void drawSpeechBubble(Canvas& canvas, const BitmapFont& font,
                             const String& text, i32 x, i32 y,
                             const Color& bgColor, const Color& textColor,
                             i32 padding = 4) {
    u32 textWidth = font.measureText(text);
    u32 textHeight = font.measureHeight(text);

    i32 bubbleWidth = textWidth + padding * 2;
    i32 bubbleHeight = textHeight + padding * 2;

    // Draw background rectangle
    for (i32 by = 0; by < bubbleHeight; by++) {
        for (i32 bx = 0; bx < bubbleWidth; bx++) {
            canvas.setPixel(x + bx, y + by, bgColor);
        }
    }

    // Draw border
    Color borderColor = Color(0, 0, 0, 255);
    for (i32 bx = 0; bx < bubbleWidth; bx++) {
        canvas.setPixel(x + bx, y, borderColor);
        canvas.setPixel(x + bx, y + bubbleHeight - 1, borderColor);
    }
    for (i32 by = 0; by < bubbleHeight; by++) {
        canvas.setPixel(x, y + by, borderColor);
        canvas.setPixel(x + bubbleWidth - 1, y + by, borderColor);
    }

    // Draw text
    font.drawText(canvas, text, x + padding, y + padding, textColor);
}

} // namespace gfx
} // namespace oracon

#endif // ORACON_GFX_TEXT_H
